# Database Migration Guide

This guide walks through the process of making database schema changes and running migrations using Alembic with an async SQLAlchemy setup.

## Prerequisites

- Existing SQLAlchemy models
- Alembic configured with async support
- PostgreSQL database

## Step 1: Update Your Model

First, update your SQLAlchemy model with the new fields or changes. For example, to add new fields to the User model:

```python
# app/models/user.py

from sqlalchemy import Column, Integer, String, DateTime, Boolean, text
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.sql import func
import uuid
from app.db.base import Base

class User(Base):
    __tablename__ = "users"
    
    # Existing fields
    id = Column(Integer, primary_key=True, index=True)
    uuid = Column(UUID(as_uuid=True), unique=True, nullable=False, default=uuid.uuid4)
    username = Column(String, nullable=True)
    auth_token = Column(String, nullable=True)
    
    # New fields being added
    name = Column(String, nullable=True)
    name_last = Column(String, nullable=True)
    name_first = Column(String, nullable=True)
    name_middle = Column(String, nullable=True)
    name_prefix = Column(String, nullable=True)
    name_suffix = Column(String, nullable=True)
    
    # More new fields
    email = Column(String, nullable=True)
    mobile = Column(String, nullable=True)
    dob = Column(DateTime, nullable=True)
    place_of_birth = Column(String, nullable=True)
    
    # Status and timestamps
    is_active = Column(Boolean, nullable=False, server_default=text('true'))
    created_at = Column(DateTime, nullable=False, server_default=func.current_timestamp())
    updated_at = Column(DateTime, nullable=False, server_default=func.current_timestamp(), onupdate=func.current_timestamp())
```

## Step 2: Update Pydantic Models

Update your Pydantic models to include the new fields:

```python
# app/schemas/user.py

from pydantic import BaseModel, EmailStr, Field
from typing import Optional
from datetime import datetime
from uuid import UUID

class UserBase(BaseModel):
    username: str = Field(..., min_length=3, max_length=150)
    email: Optional[EmailStr] = None
    is_active: Optional[bool] = True
    
    # New fields
    name: Optional[str] = None
    name_last: Optional[str] = None
    name_first: Optional[str] = None
    name_middle: Optional[str] = None
    name_prefix: Optional[str] = None
    name_suffix: Optional[str] = None
    mobile: Optional[str] = None
    dob: Optional[datetime] = None
    place_of_birth: Optional[str] = None

class UserCreate(UserBase):
    password: str = Field(..., min_length=8, max_length=255)

class UserUpdate(BaseModel):
    username: Optional[str] = Field(None, min_length=3, max_length=150)
    email: Optional[EmailStr] = None
    password: Optional[str] = Field(None, min_length=8, max_length=255)
    is_active: Optional[bool] = None
    
    # New fields
    name: Optional[str] = None
    name_last: Optional[str] = None
    name_first: Optional[str] = None
    name_middle: Optional[str] = None
    name_prefix: Optional[str] = None
    name_suffix: Optional[str] = None
    mobile: Optional[str] = None
    dob: Optional[datetime] = None
    place_of_birth: Optional[str] = None

class UserResponse(UserBase):
    id: int
    uuid: UUID
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True
```

## Step 3: Generate Migration

Run the following command to generate a new migration:

```bash
# Create new migration
alembic revision --autogenerate -m "Add name and contact fields to user model"
```

This will create a new file in `alembic/versions/` with a name like `xxxxxxxxxxxx_add_name_and_contact_fields_to_user_model.py`

## Step 4: Review Migration

Open the generated migration file and review the changes. It should look something like this:

```python
"""Add name and contact fields to user model

Revision ID: xxxxxxxxxxxx
Revises: previous_revision_id
Create Date: 2024-11-29 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic
revision = 'xxxxxxxxxxxx'
down_revision = 'previous_revision_id'
branch_labels = None
depends_on = None

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('name', sa.String(), nullable=True))
    op.add_column('users', sa.Column('name_last', sa.String(), nullable=True))
    op.add_column('users', sa.Column('name_first', sa.String(), nullable=True))
    op.add_column('users', sa.Column('name_middle', sa.String(), nullable=True))
    op.add_column('users', sa.Column('name_prefix', sa.String(), nullable=True))
    op.add_column('users', sa.Column('name_suffix', sa.String(), nullable=True))
    op.add_column('users', sa.Column('email', sa.String(), nullable=True))
    op.add_column('users', sa.Column('mobile', sa.String(), nullable=True))
    op.add_column('users', sa.Column('dob', sa.DateTime(), nullable=True))
    op.add_column('users', sa.Column('place_of_birth', sa.String(), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'place_of_birth')
    op.drop_column('users', 'dob')
    op.drop_column('users', 'mobile')
    op.drop_column('users', 'email')
    op.drop_column('users', 'name_suffix')
    op.drop_column('users', 'name_prefix')
    op.drop_column('users', 'name_middle')
    op.drop_column('users', 'name_first')
    op.drop_column('users', 'name_last')
    op.drop_column('users', 'name')
    # ### end Alembic commands ###
```

## Step 5: Apply Migration

Run the migration to update your database:

```bash
# Apply the migration
alembic upgrade head
```

## Step 6: Verify Changes

Check that the migration was applied:

```bash
# Check current revision
alembic current

# View migration history
alembic history
```

You can also connect to your database and verify the new columns:

```sql
\d users;  -- If using psql
```

## Handling Issues

If you need to rollback a migration:

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

## Best Practices

1. Always review generated migrations before applying them
2. Back up your database before running migrations in production
3. Test migrations in a development environment first
4. Keep migrations small and focused
5. Use meaningful names for migration messages
6. Don't modify existing migration files after they've been applied
7. Handle data migrations separately from schema migrations when possible